<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Enhanced Spotify-like Player with EQ Presets</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Google Fonts for modern typography -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
  <style>
    /* Global Styling */
    body {
      margin: 0;
      padding: 0;
      font-family: 'Roboto', sans-serif;
      background-color: #121212;
      color: #fff;
      transition: background-color 0.3s, color 0.3s;
      background-size: cover;
      background-position: center;
    }
    /* Light theme override */
    .light-theme {
      background-color: #f0f0f0;
      color: #000;
    }
    .light-theme .sidebar {
      background-color: #e0e0e0;
    }
    .light-theme .main-content {
      background-color: #fff;
    }
    /* Updated grid: sidebar (250px), main content (flexible), lyrics panel (300px) */
    .app-container {
      display: grid;
      grid-template-columns: 250px 1fr 300px;
      height: 100vh;
    }
    /* Sidebar (Playlist Banner) */
    .sidebar {
      background-color: #1e1e1e;
      padding: 20px;
      box-shadow: 2px 0 5px rgba(0,0,0,0.5);
      display: flex;
      flex-direction: column;
    }
    .sidebar button {
      background-color: #5907f0;
      border: none;
      color: #fff;
      padding: 10px;
      border-radius: 5px;
      cursor: pointer;
      margin-bottom: 10px;
      transition: background-color 0.2s;
    }
    .sidebar button:hover {
      background-color: #5977f0;
    }
    .playlist-controls {
      margin-top: auto;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    .playlist-item {
      background-color: #2c2c2c;
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 5px;
      cursor: pointer;
      display: flex;
      align-items: center;
      transition: background-color 0.2s;
    }
    .playlist-item:hover,
    .playlist-item.active {
      background-color: #5977f0;
    }
    .playlist-item img {
      width: 40px;
      height: 40px;
      object-fit: cover;
      margin-right: 10px;
      border-radius: 3px;
    }
    /* Main Content Area */
    .main-content {
      padding: 20px;
      overflow-y: auto;
    }
    .player {
      text-align: center;
      margin-bottom: 30px;
    }
    .album-cover {
      width: 300px;
      height: 300px;
      border-radius: 5px;
      object-fit: cover;
      margin: 0 auto 10px auto;
      position: relative;
      overflow: hidden;
    }
    /* Shine Effect for Album Cover (when playing) */
    .album-cover.shine::after {
      content: "";
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(120deg, transparent, rgba(255,255,255,0.3), transparent);
      animation: shine 2s infinite;
    }
    @keyframes shine {
      0% { left: -100%; }
      50% { left: 100%; }
      100% { left: 100%; }
    }
    .song-title {
      font-size: 24px;
      margin-bottom: 10px;
    }
    .controls button {
      background-color: #5907f0;
      border: none;
      color: #fff;
      padding: 10px 20px;
      margin: 5px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.2s;
    }
    .controls button:hover {
      background-color: #5977f0;
    }
    .progress-container {
      width: 80%;
      max-width: 300px;
      background-color: #2c2c2c;
      height: 5px;
      border-radius: 2px;
      margin: 10px auto;
      overflow: hidden;
      cursor: pointer;
    }
    .progress {
      width: 0%;
      height: 100%;
      background-color: #5907f0;
      border-radius: 2px;
      transition: width 0.1s linear;
    }
    #timeDisplay {
      font-size: 14px;
      margin-top: 5px;
    }
    .volume-container {
      margin-top: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    .volume-container input[type=range] {
      width: 150px;
      height: 4px;
      -webkit-appearance: none;
      background: #2c2c2c;
      border-radius: 2px;
      outline: none;
    }
    .volume-container input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: #ff4b26;
      cursor: pointer;
    }
    /* Current Playlist Songs List with drag-and-drop */
    .songs-list {
      margin-top: 20px;
    }
    .song-item {
      display: flex;
      align-items: center;
      background-color: #2c2c2c;
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 5px;
      transition: background-color 0.2s;
      cursor: pointer;
    }
    .song-item:hover {
      background-color: #5977f0;
    }
    .song-item img {
      width: 50px;
      height: 50px;
      object-fit: cover;
      border-radius: 3px;
      margin-right: 10px;
    }
    .song-item .song-info {
      flex: 1;
    }
    .song-item .remove-btn {
      background-color: #5907f0;
      border: none;
      color: #fff;
      padding: 5px 10px;
      border-radius: 15px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .song-item .remove-btn:hover {
      background-color: #5977f0;
    }
    /* Available Songs List */
    .available-songs {
      margin-top: 30px;
    }
    .available-songs h2 {
      margin-bottom: 10px;
    }
    .available-songs .song-item {
      background-color: #2c2c2c;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .available-songs .song-item button {
      background-color: #ff4b26;
      border: none;
      color: #fff;
      padding: 5px 10px;
      border-radius: 15px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .available-songs .song-item button:hover {
      background-color: #ff7b5c;
    }
    /* EQ Modal Styles */
    #eqModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }
    #eqModal .modal-content {
      background: #222;
      padding: 20px;
      border-radius: 10px;
      width: 350px;
      text-align: center;
    }
    #eqModal button {
      background-color: #ff4b26;
      border: none;
      color: #fff;
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      margin-top: 10px;
    }
    /* Equalizer Visual Interface */
    .eq-container {
      display: flex;
      justify-content: space-around;
      align-items: flex-end;
      margin: 20px 0;
      height: 200px;
      border-left: 1px solid #555;
      border-right: 1px solid #555;
      position: relative;
    }
    .eq-band {
      position: relative;
      width: 40px;
      height: 100%;
    }
    .eq-track {
      position: absolute;
      left: 50%;
      top: 0;
      transform: translateX(-50%);
      width: 4px;
      height: 100%;
      background-color: #555;
    }
    .eq-dot {
      position: absolute;
      left: 50%;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background-color: #ff4b26;
      transform: translate(-50%, -50%);
      cursor: pointer;
      user-select: none;
    }
    .eq-label {
      text-align: center;
      margin-top: 5px;
      font-size: 14px;
    }
    .eq-preset-controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    .eq-preset-controls select {
      background-color: #2c2c2c;
      color: #fff;
      border: 1px solid #555;
      padding: 5px;
      border-radius: 5px;
    }
    /* Additional styling for drag-and-drop */
    .song-item.dragging {
      opacity: 0.5;
    }
    /* Lyrics Panel Styling - initially hidden */
    #lyricsPanel {
      padding: 20px;
      background-color: #1e1e1e;
      overflow-y: auto;
      color: #fff;
      display: none;
    }
  </style>
</head>
<body>

  <!-- Notification Banner for Suggested Tracks -->
  <div id="notificationBanner" style="position:fixed; top:10px; right:10px; background:#5907f0; padding:10px; border-radius:5px; display:none; z-index:3000;" aria-live="polite"></div>
  
  <!-- EQ Modal -->
  <div id="eqModal">
    <div class="modal-content">
      <h2>Equalizer</h2>
      <div class="eq-preset-controls">
        <select id="eqPresetSelect" aria-label="Select EQ Preset">
          <option value="">-- Select Preset --</option>
        </select>
        <button id="saveEqPresetBtn" aria-label="Save EQ Preset">Save Preset</button>
      </div>
      <div class="eq-container" id="eqContainer">
        <div class="eq-band" data-freq="60">
          <div class="eq-track"></div>
          <div class="eq-dot" id="eqDot0"></div>
          <div class="eq-label">60Hz</div>
        </div>
        <div class="eq-band" data-freq="150">
          <div class="eq-track"></div>
          <div class="eq-dot" id="eqDot1"></div>
          <div class="eq-label">150Hz</div>
        </div>
        <div class="eq-band" data-freq="400">
          <div class="eq-track"></div>
          <div class="eq-dot" id="eqDot2"></div>
          <div class="eq-label">400Hz</div>
        </div>
        <div class="eq-band" data-freq="1000">
          <div class="eq-track"></div>
          <div class="eq-dot" id="eqDot3"></div>
          <div class="eq-label">1kHz</div>
        </div>
        <div class="eq-band" data-freq="2400">
          <div class="eq-track"></div>
          <div class="eq-dot" id="eqDot4"></div>
          <div class="eq-label">2.4kHz</div>
        </div>
        <div class="eq-band" data-freq="15000">
          <div class="eq-track"></div>
          <div class="eq-dot" id="eqDot5"></div>
          <div class="eq-label">15kHz</div>
        </div>
      </div>
      <button id="closeEqBtn" aria-label="Close Equalizer">Close</button>
    </div>
  </div>
  
  <div class="app-container">
    <!-- Sidebar for Playlists, Theme Toggle, Settings & Lyrics -->
    <div class="sidebar">
      <button id="addPlaylistBtn" aria-label="Add Playlist">Add Playlist</button>
      <div id="playlistSidebar">
        <!-- Playlist items injected here -->
      </div>
      <div class="playlist-controls">
        <button id="renamePlaylistBtn" aria-label="Rename Playlist">Rename Playlist</button>
        <button id="deletePlaylistBtn" aria-label="Delete Playlist">Delete Playlist</button>
        <button id="sortPlaylistBtn" aria-label="Sort Current Playlist">Sort Playlist</button>
      </div>
      <button id="themeToggleBtn" aria-label="Toggle Theme">Toggle Theme</button>
      <button id="settingsBtn" aria-label="Open Settings">Settings</button>
      <!-- Lyrics button toggles the lyrics panel -->
      <button id="lyricsBtn" aria-label="Toggle Lyrics">Lyrics</button>
    </div>
    
    <!-- Main Content Area -->
    <div class="main-content">
      <div class="player">
        <img id="albumCover" class="album-cover" src="covers/default.jpg" alt="Album Cover">
        <div id="songTitle" class="song-title">No song playing</div>
        <!-- Clickable Progress Bar -->
        <div class="progress-container" id="progressContainer" aria-label="Song Progress">
          <div id="progress" class="progress"></div>
        </div>
        <div id="timeDisplay">0:00 / 0:00</div>
        <div class="controls">
          <button id="prevBtn" aria-label="Previous Song">Prev</button>
          <button id="playPauseBtn" aria-label="Play or Pause">Play</button>
          <button id="nextBtn" aria-label="Next Song">Next</button>
          <button id="shuffleBtn" aria-label="Toggle Shuffle">Shuffle Off</button>
          <button id="repeatBtn" aria-label="Toggle Repeat">Repeat Off</button>
          <button id="fullscreenBtn" aria-label="Toggle Fullscreen">Fullscreen</button>
          <!-- Visualizer Mode Button -->
          <button id="visualizerModeBtn" aria-label="Switch Visualizer Mode">Visualizer Mode</button>
        </div>
        <div class="volume-container">
          <label for="volumeSlider">Volume:</label>
          <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="1" aria-label="Volume Slider">
        </div>
      </div>
      
      <!-- Audio Visualizer -->
      <canvas id="visualizer" width="300" height="100" style="background:#2c2c2c; display:block; margin:10px auto;"></canvas>
      
      <!-- Current Playlist Songs (with drag-and-drop) -->
      <div class="songs-list" id="playlistSongs">
        <!-- Songs injected here -->
      </div>
      
      <!-- Available Songs List with Search -->
      <div class="available-songs">
        <h2>Available Songs</h2>
        <input type="text" id="songSearch" placeholder="Search songs..." style="width:100%; padding:5px; margin-bottom:10px;" aria-label="Search Songs">
        <ul id="availableSongs">
          <!-- Available songs injected here -->
        </ul>
      </div>
    </div>
    
    <!-- Lyrics Panel (initially hidden) -->
    <div id="lyricsPanel">
      <!-- Lyrics will appear here once toggled -->
    </div>
  </div>
  
  <!-- Hidden Audio Element -->
  <audio id="audioPlayer"></audio>
  
  <script>
    // Global flag to indicate if lyrics panel is active (visible)
    let lyricsActive = false;

    // ===== Audio & EQ Setup =====
    const audioPlayer = document.getElementById("audioPlayer");
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const sourceNode = audioCtx.createMediaElementSource(audioPlayer);
    const eqBands = [
      { freq: 60, filter: null, dot: null },
      { freq: 150, filter: null, dot: null },
      { freq: 400, filter: null, dot: null },
      { freq: 1000, filter: null, dot: null },
      { freq: 2400, filter: null, dot: null },
      { freq: 15000, filter: null, dot: null }
    ];
    let lastNode = sourceNode;
    eqBands.forEach((band) => {
      const filter = audioCtx.createBiquadFilter();
      filter.type = "peaking";
      filter.frequency.value = band.freq;
      filter.gain.value = 0;
      filter.Q.value = 1.0;
      band.filter = filter;
      lastNode.connect(filter);
      lastNode = filter;
    });
    lastNode.connect(audioCtx.destination);
    
    // Initialize EQ dots positions
    const containerHeight = 200;
    eqBands.forEach((band, index) => {
      band.dot = document.getElementById("eqDot" + index);
      const defaultY = containerHeight / 2;
      band.dot.style.top = defaultY + "px";
    });
    
    function yToGain(y) {
      return 12 - (y / containerHeight) * 24;
    }
    
    function gainToY(gain) {
      return ((12 - gain) / 24) * containerHeight;
    }
    
    let currentDrag = null;
    eqBands.forEach((band, index) => {
      band.dot.addEventListener("mousedown", (e) => {
        currentDrag = { bandIndex: index, startY: e.clientY };
        document.addEventListener("mousemove", onDrag);
        document.addEventListener("mouseup", stopDrag);
      });
    });
    
    function onDrag(e) {
      if (!currentDrag) return;
      const band = eqBands[currentDrag.bandIndex];
      const parentRect = band.dot.parentElement.getBoundingClientRect();
      let newY = e.clientY - parentRect.top;
      newY = Math.max(0, Math.min(containerHeight, newY));
      band.dot.style.top = newY + "px";
      band.filter.gain.value = yToGain(newY);
    }
    
    function stopDrag() {
      currentDrag = null;
      document.removeEventListener("mousemove", onDrag);
      document.removeEventListener("mouseup", stopDrag);
    }
    
    const EQ_PRESETS_KEY = "eqPresets";
    let eqPresets = {};
    
    function loadEqPresets() {
      const stored = localStorage.getItem(EQ_PRESETS_KEY);
      // Add default recommended presets if none stored
      eqPresets = stored ? JSON.parse(stored) : {
        "Rock": [5, 3, -2, -2, 3, 5],
        "Jazz": [2, 2, 0, 0, 2, 2],
        "Pop": [3, 2, -1, -1, 2, 3]
      };
      updateEqPresetDropdown();
    }
    
    function updateEqPresetDropdown() {
      const eqPresetSelect = document.getElementById("eqPresetSelect");
      eqPresetSelect.innerHTML = '<option value="">-- Select Preset --</option>';
      for (let presetName in eqPresets) {
        const option = document.createElement("option");
        option.value = presetName;
        option.textContent = presetName;
        eqPresetSelect.appendChild(option);
      }
    }
    
    function saveCurrentEqPreset(presetName) {
      const gains = eqBands.map(band => band.filter.gain.value);
      eqPresets[presetName] = gains;
      localStorage.setItem(EQ_PRESETS_KEY, JSON.stringify(eqPresets));
      updateEqPresetDropdown();
    }
    
    document.getElementById("saveEqPresetBtn").addEventListener("click", () => {
      const presetName = prompt("Enter a name for this preset:");
      if (presetName) {
        saveCurrentEqPreset(presetName);
        alert("Preset saved!");
      }
    });
    
    document.getElementById("eqPresetSelect").addEventListener("change", (e) => {
      const presetName = e.target.value;
      if (presetName && eqPresets[presetName]) {
        const gains = eqPresets[presetName];
        eqBands.forEach((band, index) => {
          band.filter.gain.value = gains[index];
          band.dot.style.top = gainToY(gains[index]) + "px";
        });
      }
    });
    
    // ===== Playlist & Player Functionality =====
    const availableSongs = [
      "Yuno Miles - 4 Wheeler.mp3",
      "Stray Kids - JJAM.mp3",
      "Smino - Anita.mp3",
      "Stray Kids - Chk Chk Boom (Deadeye Ver.).mp3",
      "Stray Kids - Chk Chk Boom (Heatwave Ver.).mp3",
      "Stray Kids - Lose My Breath (Stray Kids Ver.).mp3",
      "Stray Kids - I GOT IT (HAN).mp3",
      "Stray Kids - Hug Me (I.N).mp3",
      "Kendrick Lamar - HUMBLE..mp3",
      "Kendrick Lamar - m.A.A.d city.mp3",
      "Stray Kids - Red Lights (Bang Chan, Hyunjin).mp3",
      "Stray Kids - LALALALA (Rock Ver.).mp3",
      "Stray Kids - Boxer.mp3",
      "Kendrick Lamar - euphoria.mp3",
      "Kendrick Lamar - DUCKWORTH..mp3",
      "Kendrick Lamar - DNA..mp3",
      "Kendrick Lamar - King Kunta.mp3",
      "Jean Grae - Hater's Anthem.mp3",
      "Yuno Miles - Martin Luther.mp3",
      "Stray Kids - Cover Me.mp3",
      "Kendrick Lamar - Backseat Freestyle.mp3",
      "Smino - Blu Billy.mp3",
      "Yuno Miles - Honey Bun.mp3",
      "Stray Kids - Bounce Back.mp3",
      "Kendrick Lamar - hey now (feat. dody6).mp3",
      "Kendrick Lamar - tv off (feat. lefty gunplay).mp3",
      "The Bangles - Walk Like an Egyptian.mp3",
      "Ley Soul - Intergalactic Janet.mp3",
      "Diamond is unbreakable.mp3",
      "Stray Kids - SUPER BOARD.mp3",
      "Stray Kids - School Life.mp3",
      "Stray Kids - Give Me Your TMI.mp3",
      "Stray Kids - Awkward Silence.mp3",
      "Stray Kids - ROCK.mp3",
      "Stray Kids - ZONE (Bang Chan, Changbin, HAN).mp3",
      "Stray Kids - Battle Ground.mp3",
      "Stray Kids - Novel.mp3",
      "Stray Kids - HEYDAY (Prod. Czaer).mp3",
      "Stray Kids - TA.mp3",
      "Stray Kids - Airplane.mp3",
      "Stray Kids - Any.mp3",
      "Stray Kids - So Good (Hyunjin).mp3",
      "Stray Kids - DOMINO (English Ver.).mp3",
      "Stray Kids - ITEM.mp3",
      "Stray Kids - CINEMA (Lee Know & Seungmin).mp3",
      "Stray Kids - As we are (Seungmin).mp3",
      "Stray Kids - Railway (Bang Chan).mp3",
      "Stray Kids - YOUTH (Lee Know).mp3",
      "Stray Kids - ULTRA (Changbin).mp3",
      "Stray Kids - HALLUCINATION (I.N).mp3",
      "Stray Kids - So Good (Hyunjin).mp3",
      "Stray Kids - Hold My Hand (HAN).mp3",
      "Stray Kids - Unfair (Felix).mp3",
      "Stray Kids - Burnin’ Tires (Changbin & I.N).mp3",
      "Stray Kids - ESCAPE (Bang Chan & Hyunjin).mp3",
      "Stray Kids - Truman (HAN & Felix).mp3",
      "wiggles.mp3",

    ];
    let playlists = {};
    let currentPlaylistName = "";
    let currentIndex = 0;
    let isShuffle = false;
    let shuffleOrder = [];
    let shuffleIndex = 0;
    
    const albumCover = document.getElementById("albumCover");
    const songTitleDisplay = document.getElementById("songTitle");
    const progressBar = document.getElementById("progress");
    const timeDisplay = document.getElementById("timeDisplay");
    const volumeSlider = document.getElementById("volumeSlider");
    const playlistSongsContainer = document.getElementById("playlistSongs");
    const playlistSidebar = document.getElementById("playlistSidebar");
    
    const PLAYLISTS_KEY = "playlists";
    const CURRENT_PLAYLIST_KEY = "currentPlaylist";
    
    function loadPlaylists() {
      const stored = localStorage.getItem(PLAYLISTS_KEY);
      playlists = stored ? JSON.parse(stored) : { "My Playlist": [] };
      if (!stored) savePlaylists();
      const current = localStorage.getItem(CURRENT_PLAYLIST_KEY);
      currentPlaylistName = (current && playlists[current]) ? current : Object.keys(playlists)[0];
      localStorage.setItem(CURRENT_PLAYLIST_KEY, currentPlaylistName);
      updatePlaylistSidebar();
      updatePlaylistDisplay();
    }
    
    function savePlaylists() {
      localStorage.setItem(PLAYLISTS_KEY, JSON.stringify(playlists));
    }
    
    function updatePlaylistSidebar() {
      playlistSidebar.innerHTML = "";
      for (let name in playlists) {
        const div = document.createElement("div");
        div.className = "playlist-item" + (name === currentPlaylistName ? " active" : "");
        const coverImg = document.createElement("img");
        if (playlists[name].length > 0) {
          const firstSong = playlists[name][0];
          coverImg.src = "covers/" + firstSong.replace(".mp3", "") + ".jpg";
        } else {
          coverImg.src = "covers/default.jpg";
        }
        const span = document.createElement("span");
        span.textContent = name;
        div.appendChild(coverImg);
        div.appendChild(span);
        div.addEventListener("click", () => {
          currentPlaylistName = name;
          localStorage.setItem(CURRENT_PLAYLIST_KEY, currentPlaylistName);
          updatePlaylistSidebar();
          updatePlaylistDisplay();
        });
        playlistSidebar.appendChild(div);
      }
    }
    
    function updatePlaylistDisplay() {
      playlistSongsContainer.innerHTML = "";
      const currentPlaylist = playlists[currentPlaylistName];
      currentPlaylist.forEach((song, index) => {
        const div = document.createElement("div");
        div.className = "song-item";
        div.addEventListener("click", () => playSong(index));
        // Add drag-and-drop functionality
        addDragAndDropListeners(div, index);
        const img = document.createElement("img");
        const baseName = song.replace(".mp3", "");
        img.src = "covers/" + baseName + ".jpg";
        const infoDiv = document.createElement("div");
        infoDiv.className = "song-info";
        infoDiv.textContent = baseName;
        const removeBtn = document.createElement("button");
        removeBtn.className = "remove-btn";
        removeBtn.textContent = "Remove";
        removeBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          removeFromPlaylist(index);
        });
        div.appendChild(img);
        div.appendChild(infoDiv);
        div.appendChild(removeBtn);
        playlistSongsContainer.appendChild(div);
      });
    }
    
    function addDragAndDropListeners(item, index) {
      item.setAttribute("draggable", true);
      item.addEventListener("dragstart", (e) => {
        e.dataTransfer.setData("text/plain", index);
        item.classList.add("dragging");
      });
      item.addEventListener("dragend", () => {
        item.classList.remove("dragging");
      });
      item.addEventListener("dragover", (e) => {
        e.preventDefault();
      });
      item.addEventListener("drop", (e) => {
        e.preventDefault();
        const fromIndex = e.dataTransfer.getData("text/plain");
        const toIndex = index;
        if (fromIndex === toIndex) return;
        const currentPlaylist = playlists[currentPlaylistName];
        const movedItem = currentPlaylist.splice(fromIndex, 1)[0];
        currentPlaylist.splice(toIndex, 0, movedItem);
        savePlaylists();
        updatePlaylistDisplay();
      });
    }
    
    function addToPlaylist(song) {
      playlists[currentPlaylistName].push(song);
      savePlaylists();
      updatePlaylistDisplay();
      updatePlaylistSidebar();
    }
    
    function removeFromPlaylist(index) {
      playlists[currentPlaylistName].splice(index, 1);
      savePlaylists();
      updatePlaylistDisplay();
      updatePlaylistSidebar();
    }
    
    function loadAvailableSongs() {
      const availableSongsList = document.getElementById("availableSongs");
      availableSongsList.innerHTML = "";
      availableSongs.forEach(song => {
        const li = document.createElement("li");
        li.className = "song-item";
        li.textContent = song.replace(".mp3", "");
        const addButton = document.createElement("button");
        addButton.textContent = "Add";
        addButton.onclick = (e) => {
          e.stopPropagation();
          addToPlaylist(song);
        };
        li.appendChild(addButton);
        availableSongsList.appendChild(li);
      });
    }
    
    function playSong(index) {
      const currentPlaylist = playlists[currentPlaylistName];
      if (index < 0 || index >= currentPlaylist.length) return;
      currentIndex = index;
      // If shuffle is active, update the shuffle pointer
      if(isShuffle) {
        shuffleIndex = shuffleOrder.indexOf(currentIndex);
      }
      const song = currentPlaylist[currentIndex];
      audioPlayer.src = "songs/" + song;
      if(audioCtx.state === "suspended") audioCtx.resume();
      audioPlayer.play();
      updatePlayerDisplay(song);
      // If lyrics panel is active, fetch new lyrics automatically.
      if (lyricsActive) {
        fetchLyricsOvH(song);
      }
    }
    // Starting at line 220 in updatePlayerDisplay():
// Predefined mapping of album names to their palette colors.
const albumPalettes = {
  "Stray Kids - Any": {
    dominant: [123, 200, 150],
    secondary: [90, 150, 120]
  },
  "Stray Kids - Airplane": {
    dominant: [80, 160, 220],
    secondary: [60, 130, 190]
  },
  // Add additional album palettes here…
};

function updatePlayerDisplay(song) {
  const baseName = song.replace(".mp3", "");
  albumCover.src = "covers/" + baseName + ".jpg";
  songTitleDisplay.textContent = baseName;
  
  // Look up the palette for the album.
  const palette = albumPalettes[baseName];
  if (palette) {
    const color1 = `rgb(${palette.dominant[0]}, ${palette.dominant[1]}, ${palette.dominant[2]})`;
    const color2 = `rgb(${palette.secondary[0]}, ${palette.secondary[1]}, ${palette.secondary[2]})`;
    document.body.style.background = `linear-gradient(135deg, ${color1}, ${color2})`;
  } else {
    // Fallback gradient if no palette is defined.
    document.body.style.background = `linear-gradient(135deg, #333, #555)`;
  }
  document.body.style.backgroundSize = 'cover';
  document.body.style.backgroundPosition = 'center';
}

    
    function createShuffleOrder() {
      const currentPlaylist = playlists[currentPlaylistName];
      shuffleOrder = currentPlaylist.map((_, idx) => idx);
      // Shuffle using Fisher-Yates algorithm
      for (let i = shuffleOrder.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffleOrder[i], shuffleOrder[j]] = [shuffleOrder[j], shuffleOrder[i]];
      }
      // Set the pointer to the current song's position in the shuffled order
      shuffleIndex = shuffleOrder.indexOf(currentIndex);
    }
    
    function nextSong() {
      const currentPlaylist = playlists[currentPlaylistName];
      if (currentPlaylist.length === 0) return;
      if (isShuffle) {
        shuffleIndex++;
        if(shuffleIndex >= shuffleOrder.length){
          createShuffleOrder();
        }
        currentIndex = shuffleOrder[shuffleIndex];
      } else {
        currentIndex = (currentIndex + 1) % currentPlaylist.length;
      }
      playSong(currentIndex);
    }
    
    function prevSong() {
      const currentPlaylist = playlists[currentPlaylistName];
      if (currentPlaylist.length === 0) return;
      if (isShuffle) {
        shuffleIndex--;
        if(shuffleIndex < 0){
          createShuffleOrder();
          shuffleIndex = shuffleOrder.length - 1;
        }
        currentIndex = shuffleOrder[shuffleIndex];
      } else {
        currentIndex = (currentIndex - 1 + currentPlaylist.length) % currentPlaylist.length;
      }
      playSong(currentIndex);
    }
    
    // Clickable progress bar implementation
    const progressContainer = document.getElementById("progressContainer");
    progressContainer.addEventListener("click", (e) => {
      const rect = progressContainer.getBoundingClientRect();
      const clickX = e.clientX - rect.left;
      const width = rect.width;
      const clickPercent = clickX / width;
      if(audioPlayer.duration) {
         audioPlayer.currentTime = clickPercent * audioPlayer.duration;
      }
    });
    
    document.getElementById("playPauseBtn").addEventListener("click", () => {
      const currentPlaylist = playlists[currentPlaylistName];
      if (!isPlaying) {
        if (!audioPlayer.src && currentPlaylist.length > 0) {
          playSong(currentIndex);
        } else {
          audioPlayer.play();
          isPlaying = true;
          document.getElementById("playPauseBtn").textContent = "Pause";
          albumCover.classList.add("shine");
        }
      } else {
        audioPlayer.pause();
        isPlaying = false;
        document.getElementById("playPauseBtn").textContent = "Play";
        albumCover.classList.remove("shine");
      }
    });
    
    document.getElementById("nextBtn").addEventListener("click", nextSong);
    document.getElementById("prevBtn").addEventListener("click", prevSong);
    
    document.getElementById("shuffleBtn").addEventListener("click", () => {
      isShuffle = !isShuffle;
      document.getElementById("shuffleBtn").textContent = isShuffle ? "Shuffle On" : "Shuffle Off";
      if(isShuffle) {
        createShuffleOrder();
      }
    });
    // Repeat functionality: 0 = off, 1 = repeat one, 2 = repeat all
    let repeatMode = 0;
    const repeatBtn = document.getElementById("repeatBtn");
    repeatBtn.addEventListener("click", () => {
      repeatMode = (repeatMode + 1) % 3;
      if (repeatMode === 0) {
        repeatBtn.textContent = "Repeat Off";
      } else if (repeatMode === 1) {
        repeatBtn.textContent = "Repeat One";
      } else {
        repeatBtn.textContent = "Repeat All";
      }
    });
    
    // Suggested track notification function
    function showNotification(message, duration = 3000) {
      const banner = document.getElementById("notificationBanner");
      banner.textContent = message;
      banner.style.display = "block";
      setTimeout(() => {
         banner.style.display = "none";
      }, duration);
    }
    
    function suggestTrack() {
      const currentPlaylist = playlists[currentPlaylistName];
      const suggestions = availableSongs.filter(song => !currentPlaylist.includes(song));
      if(suggestions.length > 0) {
         const suggestion = suggestions[Math.floor(Math.random() * suggestions.length)];
         showNotification("Suggested Track: " + suggestion.replace(".mp3", "") + " (Click to add)", 5000);
         document.getElementById("notificationBanner").onclick = () => {
              addToPlaylist(suggestion);
              showNotification(suggestion.replace(".mp3", "") + " added to playlist!", 3000);
         }
      }
    }
    
    audioPlayer.addEventListener("ended", () => {
      if (repeatMode === 1) {
        playSong(currentIndex);
      } else if (repeatMode === 2) {
        nextSong();
      } else {
        nextSong();
      }
      // Show suggested track notification after a short delay
      setTimeout(suggestTrack, 2000);
    });
    
    // Time update and progress bar update
    audioPlayer.addEventListener("timeupdate", () => {
      if (audioPlayer.duration) {
        const progressPercent = (audioPlayer.currentTime / audioPlayer.duration) * 100;
        progressBar.style.width = progressPercent + "%";
        timeDisplay.textContent = formatTime(audioPlayer.currentTime) + " / " + formatTime(audioPlayer.duration);
      }
    });
    
    function formatTime(time) {
      const minutes = Math.floor(time / 60);
      const seconds = Math.floor(time % 60).toString().padStart(2, "0");
      return minutes + ":" + seconds;
    }
    
    volumeSlider.addEventListener("input", (e) => {
      audioPlayer.volume = e.target.value;
    });
    
    // Fullscreen functionality
    const fullscreenBtn = document.getElementById("fullscreenBtn");
    fullscreenBtn.addEventListener("click", () => {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen();
        fullscreenBtn.textContent = "Exit Fullscreen";
      } else {
        if (document.exitFullscreen) {
          document.exitFullscreen();
          fullscreenBtn.textContent = "Fullscreen";
        }
      }
    });
    
    // Theme toggle
    const themeToggleBtn = document.getElementById("themeToggleBtn");
    themeToggleBtn.addEventListener("click", () => {
      document.body.classList.toggle("light-theme");
    });
    
    // Playlist Creation, Renaming, Deletion, and Sorting
    document.getElementById("addPlaylistBtn").addEventListener("click", () => {
      const newName = prompt("Enter new playlist name:");
      if (newName && !playlists[newName]) {
        playlists[newName] = [];
        currentPlaylistName = newName;
        localStorage.setItem(CURRENT_PLAYLIST_KEY, currentPlaylistName);
        savePlaylists();
        updatePlaylistSidebar();
        updatePlaylistDisplay();
      } else {
        alert("Playlist already exists or invalid name.");
      }
    });
    
    document.getElementById("renamePlaylistBtn").addEventListener("click", () => {
      const newName = prompt("Enter new name for the current playlist:", currentPlaylistName);
      if (newName && !playlists[newName]) {
        playlists[newName] = playlists[currentPlaylistName];
        delete playlists[currentPlaylistName];
        currentPlaylistName = newName;
        localStorage.setItem(CURRENT_PLAYLIST_KEY, currentPlaylistName);
        savePlaylists();
        updatePlaylistSidebar();
        updatePlaylistDisplay();
      } else {
        alert("Invalid name or playlist already exists.");
      }
    });
    
    document.getElementById("deletePlaylistBtn").addEventListener("click", () => {
      if (confirm("Are you sure you want to delete this playlist?")) {
        delete playlists[currentPlaylistName];
        currentPlaylistName = Object.keys(playlists)[0] || "";
        localStorage.setItem(CURRENT_PLAYLIST_KEY, currentPlaylistName);
        savePlaylists();
        updatePlaylistSidebar();
        updatePlaylistDisplay();
      }
    });
    
    // Sort Playlist (Enhanced Playlist Management)
    document.getElementById("sortPlaylistBtn").addEventListener("click", () => {
      playlists[currentPlaylistName].sort((a, b) => {
         const nameA = a.toLowerCase();
         const nameB = b.toLowerCase();
         return nameA < nameB ? -1 : nameA > nameB ? 1 : 0;
      });
      savePlaylists();
      updatePlaylistDisplay();
    });
    
    // Search functionality for available songs
    document.getElementById("songSearch").addEventListener("input", (e) => {
      const query = e.target.value.toLowerCase();
      const availableSongsList = document.getElementById("availableSongs");
      availableSongsList.innerHTML = "";
      availableSongs.filter(song => song.toLowerCase().includes(query))
        .forEach(song => {
          const li = document.createElement("li");
          li.className = "song-item";
          li.textContent = song.replace(".mp3", "");
          const addButton = document.createElement("button");
          addButton.textContent = "Add";
          addButton.onclick = (e) => {
            e.stopPropagation();
            addToPlaylist(song);
          };
          li.appendChild(addButton);
          availableSongsList.appendChild(li);
        });
    });
    
    // ===== Audio Visualizer Setup with Multiple Modes =====
    const canvas = document.getElementById("visualizer");
    const canvasCtx = canvas.getContext("2d");
    const analyser = audioCtx.createAnalyser();
    analyser.fftSize = 256;
    const bufferLength = analyser.frequencyBinCount;
    const dataArray = new Uint8Array(bufferLength);
    sourceNode.connect(analyser);
    
    // Visualizer Mode Setup
    let visualizerMode = 0;
    const visualizerModes = ["bars", "waveform", "radial"];
    document.getElementById("visualizerModeBtn").addEventListener("click", () => {
      visualizerMode = (visualizerMode + 1) % visualizerModes.length;
      document.getElementById("visualizerModeBtn").textContent = "Mode: " + visualizerModes[visualizerMode];
    });
    
    function drawVisualizer() {
      requestAnimationFrame(drawVisualizer);
      canvasCtx.clearRect(0, 0, canvas.width, canvas.height);
      if (visualizerModes[visualizerMode] === "bars") {
         analyser.getByteFrequencyData(dataArray);
         const barWidth = (canvas.width / bufferLength) * 2.5;
         let barHeight;
         let x = 0;
         for (let i = 0; i < bufferLength; i++) {
             barHeight = dataArray[i] / 2;
             canvasCtx.fillStyle = "#ff4b26";
             canvasCtx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
             x += barWidth + 1;
         }
      } else if (visualizerModes[visualizerMode] === "waveform") {
         analyser.getByteTimeDomainData(dataArray);
         canvasCtx.lineWidth = 2;
         canvasCtx.strokeStyle = "#ff4b26";
         canvasCtx.beginPath();
         const sliceWidth = canvas.width / bufferLength;
         let x = 0;
         for (let i = 0; i < bufferLength; i++) {
              const v = dataArray[i] / 128.0;
              const y = v * canvas.height / 2;
              if (i === 0) {
                  canvasCtx.moveTo(x, y);
              } else {
                  canvasCtx.lineTo(x, y);
              }
              x += sliceWidth;
         }
         canvasCtx.lineTo(canvas.width, canvas.height / 2);
         canvasCtx.stroke();
      } else if (visualizerModes[visualizerMode] === "radial") {
         analyser.getByteFrequencyData(dataArray);
         const centerX = canvas.width / 2;
         const centerY = canvas.height / 2;
         const radius = Math.min(centerX, centerY);
         const angleStep = (Math.PI * 2) / bufferLength;
         for (let i = 0; i < bufferLength; i++) {
              const value = dataArray[i];
              const angle = i * angleStep;
              canvasCtx.beginPath();
              canvasCtx.moveTo(centerX, centerY);
              canvasCtx.lineTo(centerX + Math.cos(angle) * (radius + value/4), centerY + Math.sin(angle) * (radius + value/4));
              canvasCtx.strokeStyle = "#ff4b26";
              canvasCtx.stroke();
         }
      }
    }
    drawVisualizer();
    
    // ---- Lyrics Fetching using lyrics.ovh API ----
    function getArtistAndTitle(song) {
      const baseName = song.replace(".mp3", "").trim();
      if (baseName.includes(" - ")) {
        const parts = baseName.split(" - ");
        return { artist: parts[0].trim(), title: parts[1].trim() };
      } else {
        const title = baseName;
        const artist = prompt("Enter the artist for '" + title + "':");
        return { artist, title };
      }
    }
    
    function fetchLyricsOvH(song) {
      const { artist, title } = getArtistAndTitle(song);
      const apiUrl = `https://api.lyrics.ovh/v1/${encodeURIComponent(artist)}/${encodeURIComponent(title)}`;
      fetch(apiUrl)
        .then(response => {
          if (!response.ok) throw new Error("Lyrics not found");
          return response.json();
        })
        .then(data => {
          const formattedLyrics = data.lyrics
            ? data.lyrics.replace(/\n/g, '<br>')
            : "Lyrics not available.";
          document.getElementById("lyricsPanel").innerHTML = formattedLyrics;
        })
        .catch(error => {
          document.getElementById("lyricsPanel").textContent = error.message;
          console.error("Error fetching lyrics:", error);
        });
    }
    
    // Lyrics button: toggle lyrics panel and fetch lyrics if showing
    document.getElementById("lyricsBtn").addEventListener("click", () => {
      const lyricsPanel = document.getElementById("lyricsPanel");
      const currentPlaylist = playlists[currentPlaylistName];
      if (lyricsPanel.style.display === "none" || lyricsPanel.style.display === "") {
        lyricsPanel.style.display = "block";
        lyricsActive = true;
        if (currentPlaylist && currentPlaylist[currentIndex]) {
          fetchLyricsOvH(currentPlaylist[currentIndex]);
        }
      } else {
        lyricsPanel.style.display = "none";
        lyricsActive = false;
      }
    });
    
    // Settings modal controls
    document.getElementById("settingsBtn").addEventListener("click", () => {
      console.log("Settings button clicked");
      document.getElementById("eqModal").style.display = "flex";
    });
    document.getElementById("closeEqBtn").addEventListener("click", () => {
      console.log("Close button clicked");
      document.getElementById("eqModal").style.display = "none";
    });
    
    // ---- Keyboard Shortcuts & Accessibility ----
    document.addEventListener("keydown", (e) => {
      if (document.activeElement.tagName !== "INPUT" && document.activeElement.tagName !== "TEXTAREA") {
         if (e.code === "Space") {
              e.preventDefault();
              document.getElementById("playPauseBtn").click();
         } else if (e.code === "ArrowRight") {
              document.getElementById("nextBtn").click();
         } else if (e.code === "ArrowLeft") {
              document.getElementById("prevBtn").click();
         } else if (e.key.toLowerCase() === "v") {
              document.getElementById("visualizerModeBtn").click();
         }
      }
    });
    
    loadAvailableSongs();
    loadPlaylists();
    loadEqPresets();
    
    // Flag for play state
    let isPlaying = false;
  </script>
</body>
</html>

</html>
